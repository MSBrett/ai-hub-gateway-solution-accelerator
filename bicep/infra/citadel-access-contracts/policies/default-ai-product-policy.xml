<!--
    - Policies are applied in the order they appear.
    - Position <base/> inside a section to inherit policies from the outer scope.
    - Comments within policies are not preserved.
-->
<!-- Add policies as children to the <inbound>, <outbound>, <backend>, and <on-error> elements -->
<policies>
    <!-- Throttle, authorize, validate, cache, or transform the requests -->
    <inbound>
        <base />
        <!-- Extract and validate model parameter from request -->
        <include-fragment fragment-id="set-llm-requested-model" />
        
        <!-- Setting allowed models variable (comma-separated list) -->
        <set-variable name="allowedModels" value="gpt-4o,deepseek-r1" />
        
        <!-- Validate model access based on allowedModels -->
        <include-fragment fragment-id="validate-model-access" />

        <!-- Capacity management - Subscription Level: allow only assigned tpm for each HR use case subscription -->
        <llm-token-limit counter-key="@(context.Subscription.Id)" tokens-per-minute="300" estimate-prompt-tokens="false" tokens-consumed-header-name="consumed-tokens" remaining-tokens-header-name="remaining-tokens" token-quota="100000" token-quota-period="Monthly" retry-after-header-name="retry-after" />
        
        <!-- Failure to pass content safety will result in 403 error -->
        <llm-content-safety backend-id="content-safety-backend" shield-prompt="true">
            <!-- 0 is most restrictive and can be set up-to 7 -->
            <categories output-type="EightSeverityLevels">
                <category name="Hate" threshold="3" />
                <category name="Violence" threshold="3" />
            </categories>
        </llm-content-safety>
    </inbound>
    <!-- Control if and how the requests are forwarded to services  -->
    <backend>
        <base />
    </backend>
    <!-- Customize the responses -->
    <outbound>
        <base />
    </outbound>
    <!-- Handle exceptions and customize error responses  -->
    <on-error>
        <base />
        <!-- Raising throttling events (http 429 only) can help in setting up alerts in App Insights -->
        <!-- Set the following variables to customize the throttling event details -->
        <!-- <set-variable name="productName" value="@(context.Product?.Name?.ToString() ?? "Portal-Admin")" />
        <set-variable name="deploymentName" value="@((string)context.Variables.GetValueOrDefault<string>("requestedModel", "DefaultModel"))" />
        <set-variable name="appId" value="@((string)context.Variables.GetValueOrDefault<string>("appId", context.Subscription?.Id ?? "Portal-Admin-Sub"))" />
        <include-fragment fragment-id="raise-throttling-events" /> -->
    </on-error>
</policies>