<policies>
    <inbound>
        <base />
        <!-- Enable PII Blocking -->
        <set-variable name="piiBlockingEnabled" value="true" />

        <choose>
            <when condition="@(context.Variables.GetValueOrDefault<string>("piiBlockingEnabled") == "true")">

                <!-- Configure PII detection settings -->
                <set-variable name="piiAnonymizationEnabled" value="true" />
                <set-variable name="piiConfidenceThreshold" value="0.75" />
                <set-variable name="piiEntityCategoryExclusions" value="PersonType" />
                <set-variable name="piiDetectionLanguage" value="en" />

                <!-- Configure custom regex patterns for additional PII detection -->
                <set-variable name="piiRegexPatterns" value="@{
                    var patterns = new JArray {
                        new JObject {
                            ["pattern"] = @"\b\d{4}[- ]?\d{4}[- ]?\d{4}[- ]?\d{4}\b",
                            ["category"] = "CREDIT_CARD"
                        },
                        new JObject {
                            ["pattern"] = @"\b[A-Z]{2}\d{6}[A-Z]\b",
                            ["category"] = "PASSPORT_NUMBER"
                        },
                        new JObject {
                            ["pattern"] = @"\b784-\d{4}-\d{7}-\d{1}\b",
                            ["category"] = "EMIRATES_ID"
                        }
                    };
                    return patterns.ToString();
                }" />

                <!-- Capture request body for PII processing -->
                <set-variable name="piiInputContent" value="@(context.Request.Body.As<string>(preserveContent: true))" />

                <!-- Apply PII anonymization to detect PII -->
                <include-fragment fragment-id="pii-anonymization" />

                <!-- Check if any PII was detected (piiMappings will have entries if PII found) -->
                <choose>
                    <when condition="@{
                        var mappings = context.Variables.GetValueOrDefault<string>("piiMappings", "[]");
                        var mappingsArray = JArray.Parse(mappings);
                        return mappingsArray.Count > 0;
                    }">
                        <return-response>
                            <set-status code="400" reason="Bad Request" />
                            <set-header name="Content-Type" exists-action="override">
                                <value>application/json</value>
                            </set-header>
                            <set-body>@{
                                var mappings = JArray.Parse(context.Variables.GetValueOrDefault<string>("piiMappings", "[]"));
                                var categories = new HashSet<string>();
                                foreach (var mapping in mappings) {
                                    var placeholder = mapping["placeholder"].ToString();
                                    var category = placeholder.TrimStart('<').Split('_')[0];
                                    categories.Add(category);
                                }
                                return new JObject(
                                    new JProperty("error", new JObject(
                                        new JProperty("code", "PII_DETECTED"),
                                        new JProperty("message", "Request blocked: Personal Identifiable Information (PII) detected in the request."),
                                        new JProperty("detectedCategories", string.Join(", ", categories)),
                                        new JProperty("entityCount", mappings.Count)
                                    ))
                                ).ToString();
                            }</set-body>
                        </return-response>
                    </when>
                </choose>
            </when>
        </choose>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>