        <!-- PII Blocking - Detect PII and reject requests containing PII -->
        <set-variable name="piiBlockingEnabled" value="true" />
        <choose>
            <when condition="@(context.Variables.GetValueOrDefault<string>("piiBlockingEnabled") == "true")">
                <set-variable name="piiAnonymizationEnabled" value="true" />
                <set-variable name="piiConfidenceThreshold" value="{{PII_CONFIDENCE}}" />
                <set-variable name="piiEntityCategoryExclusions" value="{{PII_EXCLUSIONS}}" />
                <set-variable name="piiDetectionLanguage" value="{{PII_LANGUAGE}}" />
                <set-variable name="piiRegexPatterns" value="@{
                    var patterns = new JArray {
{{REGEX_ENTRIES}}
                    };
                    return patterns.ToString();
                }" />
                <set-variable name="piiInputContent" value="@(context.Request.Body.As<string>(preserveContent: true))" />
                <include-fragment fragment-id="pii-anonymization" />
                <choose>
                    <when condition="@{
                        var mappings = context.Variables.GetValueOrDefault<string>("piiMappings", "[]");
                        var mappingsArray = JArray.Parse(mappings);
                        return mappingsArray.Count > 0;
                    }">
                        <return-response>
                            <set-status code="400" reason="Bad Request" />
                            <set-header name="Content-Type" exists-action="override">
                                <value>application/json</value>
                            </set-header>
                            <set-body>@{
                                var mappings = JArray.Parse(context.Variables.GetValueOrDefault<string>("piiMappings", "[]"));
                                var categories = new HashSet<string>();
                                foreach (var mapping in mappings) {
                                    var placeholder = mapping["placeholder"].ToString();
                                    var category = placeholder.TrimStart('<').Split('_')[0];
                                    categories.Add(category);
                                }
                                return new JObject(
                                    new JProperty("error", new JObject(
                                        new JProperty("code", "PII_DETECTED"),
                                        new JProperty("message", "Request blocked: Personal Identifiable Information (PII) detected in the request."),
                                        new JProperty("detectedCategories", string.Join(", ", categories)),
                                        new JProperty("entityCount", mappings.Count)
                                    ))
                                ).ToString();
                            }</set-body>
                        </return-response>
                    </when>
                </choose>
            </when>
        </choose>