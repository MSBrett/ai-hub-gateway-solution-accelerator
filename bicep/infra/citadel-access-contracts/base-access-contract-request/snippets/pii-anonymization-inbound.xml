        <!-- PII Anonymization - Detect and replace PII in requests -->
        <set-variable name="piiAnonymizationEnabled" value="true" />
        <choose>
            <when condition="@(context.Variables.GetValueOrDefault<string>("piiAnonymizationEnabled") == "true")">
                <set-variable name="piiConfidenceThreshold" value="{{PII_CONFIDENCE}}" />
                <set-variable name="piiEntityCategoryExclusions" value="{{PII_EXCLUSIONS}}" />
                <set-variable name="piiDetectionLanguage" value="{{PII_LANGUAGE}}" />
                <set-variable name="piiRegexPatterns" value="@{
                    var patterns = new JArray {
{{REGEX_ENTRIES}}
                    };
                    return patterns.ToString();
                }" />
                <set-variable name="piiInputContent" value="@(context.Request.Body.As<string>(preserveContent: true))" />
                <include-fragment fragment-id="pii-anonymization" />
                <set-body>@(context.Variables.GetValueOrDefault<string>("piiAnonymizedContent"))</set-body>
            </when>
        </choose>