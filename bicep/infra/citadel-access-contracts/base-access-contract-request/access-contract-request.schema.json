{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Agent Access Contract Request",
  "description": "Defines the configuration for an AI Agent Access Contract in Citadel Gateway. This JSON file provides a user-friendly way to specify all parameters needed to generate the APIM product policy and Bicep deployment parameters.",
  "type": "object",
  "required": ["contractInfo", "infrastructure", "apiNameMapping", "services"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this JSON schema for validation and IntelliSense support"
    },
    "contractInfo": {
      "type": "object",
      "description": "Use case identification and metadata used for naming and organization",
      "required": ["businessUnit", "useCaseName", "environment"],
      "properties": {
        "businessUnit": {
          "type": "string",
          "description": "Business unit or department name (e.g., 'HR', 'Sales', 'Engineering')",
          "examples": ["HR", "Sales", "Healthcare", "Finance"]
        },
        "useCaseName": {
          "type": "string",
          "description": "Descriptive name for the use case (PascalCase, no spaces)",
          "examples": ["ChatAgent", "Assistant", "PatientAssistant"]
        },
        "environment": {
          "type": "string",
          "description": "Deployment environment identifier",
          "enum": ["DEV", "TEST", "UAT", "STAGING", "PROD"]
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the access contract purpose"
        },
        "productTerms": {
          "type": "string",
          "description": "Terms of service displayed to API subscribers",
          "default": ""
        }
      }
    },
    "infrastructure": {
      "type": "object",
      "description": "Target Azure infrastructure for the access contract deployment",
      "required": ["apim"],
      "properties": {
        "apim": {
          "type": "object",
          "description": "API Management instance coordinates",
          "required": ["subscriptionId", "resourceGroupName", "name"],
          "properties": {
            "subscriptionId": { "type": "string", "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$" },
            "resourceGroupName": { "type": "string" },
            "name": { "type": "string" }
          }
        },
        "keyVault": {
          "type": "object",
          "description": "Azure Key Vault for storing endpoint URLs and API keys. Set enabled=false to output secrets directly.",
          "properties": {
            "enabled": { "type": "boolean", "default": false, "description": "Whether to store secrets in Key Vault (recommended for production)" },
            "subscriptionId": { "type": "string" },
            "resourceGroupName": { "type": "string" },
            "name": { "type": "string" }
          }
        },
        "foundry": {
          "type": "object",
          "description": "Azure AI Foundry integration for creating APIM connections for AI agents",
          "properties": {
            "enabled": { "type": "boolean", "default": false, "description": "Whether to create Foundry APIM connections" },
            "subscriptionId": { "type": "string" },
            "resourceGroupName": { "type": "string" },
            "accountName": { "type": "string" },
            "projectName": { "type": "string" },
            "config": {
              "type": "object",
              "description": "Advanced Foundry connection configuration (optional - defaults are used if omitted)",
              "properties": {
                "connectionNamePrefix": { "type": "string", "default": "" },
                "deploymentInPath": { "type": "string", "default": "false" },
                "isSharedToAll": { "type": "boolean", "default": false },
                "inferenceAPIVersion": { "type": "string", "default": "" },
                "deploymentAPIVersion": { "type": "string", "default": "" }
              }
            }
          }
        }
      }
    },
    "apiNameMapping": {
      "type": "object",
      "description": "Map of service codes to their API names in APIM. API names must already exist in your APIM instance.",
      "additionalProperties": {
        "type": "array",
        "items": { "type": "string" },
        "description": "Array of APIM API names for this service code"
      },
      "examples": [
        { "LLM": ["universal-llm-api", "azure-openai-api"] },
        { "DOC": ["document-intelligence-api"] }
      ]
    },
    "services": {
      "type": "array",
      "description": "AI services to onboard. Each service creates an APIM product, subscription, and optionally Key Vault secrets.",
      "items": {
        "type": "object",
        "required": ["code", "endpointSecretName", "apiKeySecretName"],
        "properties": {
          "code": {
            "type": "string",
            "description": "Service identifier matching a key in apiNameMapping (e.g., 'LLM', 'DOC', 'SRCH')"
          },
          "endpointSecretName": {
            "type": "string",
            "description": "Name for the endpoint URL secret in Key Vault"
          },
          "apiKeySecretName": {
            "type": "string",
            "description": "Name for the API key secret in Key Vault"
          }
        }
      }
    },
    "policies": {
      "type": "object",
      "description": "Policy configuration for the access contract. Each section is optional - omit or set enabled=false to skip.",
      "properties": {
        "modelAccess": {
          "type": "object",
          "description": "Controls which LLM models the product can access",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "allowedModels": {
              "type": "array",
              "items": { "type": "string" },
              "description": "List of allowed model names (e.g., ['gpt-4o', 'deepseek-r1']). Empty list = all models allowed."
            }
          }
        },
        "capacityManagement": {
          "type": "object",
          "description": "Token rate limiting and quota management",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "mode": {
              "type": "string",
              "enum": ["subscription-level", "per-model"],
              "default": "subscription-level",
              "description": "'subscription-level' applies a single limit across all models. 'per-model' sets individual limits per model."
            },
            "subscriptionLevel": {
              "type": "object",
              "description": "Single token limit applied to the entire subscription (used when mode='subscription-level')",
              "properties": {
                "tokensPerMinute": { "type": "integer", "description": "Maximum tokens per minute (TPM)" },
                "tokenQuota": { "type": "integer", "description": "Maximum tokens per quota period" },
                "tokenQuotaPeriod": { "type": "string", "enum": ["Daily", "Weekly", "Monthly"], "default": "Monthly" }
              }
            },
            "perModel": {
              "type": "array",
              "description": "Per-model token limits (used when mode='per-model')",
              "items": {
                "type": "object",
                "required": ["model", "tokensPerMinute"],
                "properties": {
                  "model": { "type": "string", "description": "Model name matching the request model identifier" },
                  "tokensPerMinute": { "type": "integer", "description": "Maximum TPM for this model" },
                  "tokenQuota": { "type": "integer", "description": "Maximum tokens per quota period for this model" },
                  "tokenQuotaPeriod": { "type": "string", "enum": ["Daily", "Weekly", "Monthly"], "default": "Monthly" }
                }
              }
            },
            "defaultModel": {
              "type": "object",
              "description": "Default token limits for models not explicitly listed in perModel",
              "properties": {
                "tokensPerMinute": { "type": "integer", "default": 100 },
                "tokenQuota": { "type": "integer", "default": 10000 },
                "tokenQuotaPeriod": { "type": "string", "enum": ["Daily", "Weekly", "Monthly"], "default": "Monthly" }
              }
            }
          }
        },
        "contentSafety": {
          "type": "object",
          "description": "Azure AI Content Safety enforcement at the gateway level",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "shieldPrompt": { "type": "boolean", "default": true, "description": "Enable prompt shielding" },
            "categories": {
              "type": "array",
              "description": "Content safety categories with severity thresholds (0=most restrictive, 7=most permissive)",
              "items": {
                "type": "object",
                "required": ["name", "threshold"],
                "properties": {
                  "name": {
                    "type": "string",
                    "enum": ["Hate", "Violence", "SelfHarm", "Sexual"],
                    "description": "Content safety category name"
                  },
                  "threshold": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 7,
                    "description": "Severity threshold (0=block all, 7=allow all)"
                  }
                }
              }
            }
          }
        },
        "piiHandling": {
          "type": "object",
          "description": "PII detection and processing using Azure AI Language Service",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "mode": {
              "type": "string",
              "enum": ["anonymize", "block"],
              "default": "anonymize",
              "description": "'anonymize' replaces PII with placeholders and restores in response. 'block' rejects requests containing PII."
            },
            "confidenceThreshold": {
              "type": "string",
              "default": "0.8",
              "description": "Minimum confidence score for PII detection (0.0-1.0). Use string format, e.g., '0.8'"
            },
            "entityCategoryExclusions": {
              "type": "string",
              "default": "",
              "description": "Comma-separated list of PII categories to exclude from detection (e.g., 'PersonType')"
            },
            "language": {
              "type": "string",
              "default": "en",
              "description": "Language code for PII detection. Use 'auto' for multilingual content."
            },
            "stateSaving": {
              "type": "boolean",
              "default": false,
              "description": "Enable Event Hub logging of PII processing activity for auditing (only applies to 'anonymize' mode)"
            },
            "customRegexPatterns": {
              "type": "array",
              "description": "Custom regex patterns for additional PII detection beyond Azure AI Language",
              "items": {
                "type": "object",
                "required": ["pattern", "category"],
                "properties": {
                  "pattern": { "type": "string", "description": "Regex pattern (JSON-escaped backslashes)" },
                  "category": { "type": "string", "description": "Category label for matched PII (e.g., 'CREDIT_CARD', 'PASSPORT_NUMBER')" }
                }
              }
            }
          }
        },
        "usageTracking": {
          "type": "object",
          "description": "Custom dimensions for LLM usage tracking and reporting",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "appIdHeader": {
              "type": "string",
              "default": "x-app-id",
              "description": "HTTP header name for application ID tracking"
            },
            "customDimension1": {
              "type": "object",
              "description": "First custom dimension mapping",
              "properties": {
                "header": { "type": "string", "description": "HTTP header name to read the value from" },
                "default": { "type": "string", "description": "Default value when header is not present" }
              }
            },
            "customDimension2": {
              "type": "object",
              "description": "Second custom dimension mapping",
              "properties": {
                "header": { "type": "string", "description": "HTTP header name to read the value from" },
                "default": { "type": "string", "description": "Default value when header is not present" }
              }
            }
          }
        },
        "alerts": {
          "type": "object",
          "description": "Alerting configuration for monitoring and incident response",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "throttlingEvents": {
              "type": "boolean",
              "default": false,
              "description": "Raise events on HTTP 429 throttling for Application Insights alerting"
            }
          }
        }
      }
    }
  }
}
